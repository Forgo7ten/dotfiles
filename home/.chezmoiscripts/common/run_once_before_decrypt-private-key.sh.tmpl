#!/bin/sh

KEY_PATH="${HOME}/.config/chezmoi/key.txt"

{{- if .use_secrets }}

# fingerprint: {{ (print (stat .chezmoi.configFile) "\n" (include .chezmoi.configFile)) | sha256sum }}

if [ ! -f "$KEY_PATH" ]; then
    mkdir -p "${HOME}/.config/chezmoi"
    chezmoi age decrypt --output "$KEY_PATH" --passphrase "{{ .chezmoi.sourceDir }}/.key.txt.age"
    chmod 600 "$KEY_PATH"
fi

{{- else }}
# --- ç¦ç”¨ Secret é€»è¾‘ ---

if [ -f "$KEY_PATH" ]; then
    echo "æ£€æµ‹åˆ° use_secrets=falseï¼Œæ­£åœ¨æ¸…ç†å¯†é’¥æ–‡ä»¶ä»¥ç¡®ä¿å®‰å…¨..."
    rm -f "$KEY_PATH"
    echo "ğŸ—‘ï¸ å¯†é’¥æ–‡ä»¶å·²åˆ é™¤"
else
    echo "å¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— éœ€æ¸…ç†"
fi

{{- end -}}
